
//Global variables
var map;
var pinLocationList;
var infoWind;

//Initialize the map and its data
function initialize() {
   
    var mapOptions = {
    zoom: 11,
    center: new google.maps.LatLng(39.7392, -104.9842),  //NOTE: Must center map in order for google maps to work
    mapTypeId: google.maps.MapTypeId.ROADMAP
       map = new google.maps.Map(document.getElementById("map-canvas-full"), mapOption
    infoWindow = new google.maps.InfoWindow
    populatePinList();
       setTimeout(function(){ 
           placeAllMarkers();
       }, 500);
}

//Place a marker for every pin in collection
function placeAllMarkers() {
       //Cache variables
    var marker, i;
   	for (i = 0; i < pinLocationList.length; i++) {
   		var pinLocation = pinLocationList[i];
    	var pos = new google.maps.LatLng(pinLocation["latitude"], pinLocation["longitude"]);
    	var markerTitle = pinLocation["schoolName"];
    	//create a new marker
    	marker = new google.maps.Marker({
    		map: map,
    		position: pos,
    		animation: google.maps.Animation.DROP,
    		title: markerTitle,
    		icon: 'http://maps.google.com/mapfiles/kml/pal3/icon31.png'
    	});
    	//setup the Info Window
    	setInfoWindow(marker, pinLocation);
    	}	//end for
}
//Configure an info window when clicking a pin
function setInfoWindow(marker, pinLocation) {
       var content = '<div style="width:400px;">'
       + '<h2>School Facts</h2>'
       + '<div id="divSchoolFactsLeft" style="float:left;">'
      	+ '<img src="' + pinLocation["fellowImage"] + '" alt="" style="width: '
      	+ pinLocation["fellowImageWidth"] + 'px; height: ' 
      	+ pinLocation["fellowImageHeight"] + 'px; margin-right: 20px; margin-bottom: 20px; border: 0px solid; float: left;"  />'
      	+ '</div>'
      	+ '<div id="divSchoolFactsRight" style="float:left;">'
       + '<strong><em>' + pinLocation["schoolName"] + '</em></strong><br/>'
       + '<strong><em>' + pinLocation["roleDescription"] + ' by </em></strong>'
       + '<a href="' + pinLocation["fellowWebsite"] + '" target=_blank><strong><em>' + pinLocation["fellow"] + '</em></strong></a>'
       + '<br/><br/>'
       + 'Year: ' + pinLocation["year"] + '<br/>'
       + 'Grades Served: ' + pinLocation["gradesServed"] + '<br/>'
       + '# of Students: ' + pinLocation["numOfStudents"] + '<br/>'
       + 'Eligible for Free/Reduced Lunch: ' + pinLocation["eligibleLunch"] + '<br/>'
       + '<br/>'
       + 'Phone: ' + pinLocation["phoneNumber"] + '<br/>'
       + 'Website: <a href="' + pinLocation["website"] + '" target="_blank">' + pinLocation["website"] + '</a>	'
       + '</div>'
       + '</div>'
       ;
       //add listener for marker click to show info window
       google.maps.event.addListener(marker, 'click', function () {
           infoWindow.setContent(content);
           infoWindow.open(map, marker);
       });
}
//Generates a random, 4 character string
function s4() {
	
	return Math.floor((1 + Math.random()) * 0x10000)
		             .toString(16)
		             .substring(1);
};
//Builds a guid-like string
function guid() {
	return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
		         s4() + '-' + s4() + s4() + s4();
}
/**************************************************************************************************/
//setup the pin data
function populatePinList() {
       $.ajax({
           url: "http://getsmartschools.org/currentSchools.txt?rndg=" + guid(),
           async: false,
           success: function (data){
               var thisJson = $.parseJSON(data);
               pinLocationList = thisJson;
           }
       });
   }	//end function populatePinList()
    /**************************************************************************************************/
